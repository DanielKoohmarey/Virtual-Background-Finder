var webcamElement=document.getElementById("webcam"),webcam=new Webcam(webcamElement,"user"),canvasPerson=document.getElementById("canvasPerson"),multiplier=.75,outputStride=16,segmentationThreshold=.75,contextPerson=canvasPerson.getContext("2d"),net,cameraFrame,screenMode;
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();window.cancelAnimationFrame=function(){return window.cancelAnimationFrame||window.mozCancelAnimationFrame}();
$("#webcam-switch").change(function(){this.checked?(console.log("trying to enable cam"),$(".md-modal").addClass("md-show"),webcam.start(!0).then(function(a){console.log("webcam started");$(".webcam-container").removeClass("d-none");$("#webcam-control").hide();$("#search-input")[0].select();$("#search-input").css("animation","glow-small 1s infinite alternate");contextPerson.clearRect(0,0,canvasPerson.width,canvasPerson.height);screenMode=window.innerWidth>window.innerHeight?"l":"p";cameraFrame=startDetectBody()})["catch"](function(a){console.log(a);
$(".modal-window > div > div").text("Failed to set webcam \ud83d\ude22. Please ensure you are using a modern browser & grant webcam permissions.");$(".modal-window").css("visibility","visible");$("#webcam-switch").prop("checked",!1)})):(webcam.stop(),cancelAnimationFrame(cameraFrame),contextPerson.clearRect(0,0,canvasPerson.width,canvasPerson.height),console.log("webcam stopped"))});$("#webcam").bind("loadedmetadata",function(){null!=net&&(cameraFrame=detectBody())});
function startDetectBody(){null==net?($(".load-cam").css("visibility","visible"),bodyPix.load({architecture:"MobileNetV1",outputStride:outputStride,multiplier:multiplier,quantBytes:4})["catch"](function(a){console.log(a);$(".load-cam").css("visibility","hidden");$(".modal-window > div > div").text("Failed to initialize body pix model \ud83d\ude22: "+a);$(".modal-window").css("visibility","visible");$("#webcam-switch").prop("checked",!1)}).then(function(a){$(".load-cam").css("visibility","hidden");
net=a;$("#canvasPerson").show();cameraFrame=detectBody();window.webcamActive=!0;"img/placeholder/default-background-no-cam.png"==$("#background-img").attr("src")&&$("#background-img").attr("src","img/placeholder/default-background.png")})):$("#canvasPerson").removeClass("d-none")}
function detectBody(){net.segmentPerson(webcamElement,{flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:segmentationThreshold})["catch"](function(a){console.log(a)}).then(function(a){null!=a&&drawBody(a)});cameraFrame=requestAnimFrame(detectBody)}
function drawBody(a){var b=document.createElement("canvas");b.width=webcamElement.width;b.height=webcamElement.height;var c=b.getContext("2d");c.drawImage(webcamElement,0,0,webcamElement.width,webcamElement.height);for(var f=c.getImageData(0,0,webcamElement.width,webcamElement.height),g=f.data,d=0;d<g.length;d+=4)0==a.data[d/4]&&(g[d+3]=0);c.imageSmoothingEnabled=!0;c.putImageData(f,0,0);var e=new Image;e.onload=function(){contextPerson.clearRect(0,0,canvasPerson.width,canvasPerson.height);contextPerson.imageSmoothingEnabled=
!0;contextPerson.drawImage(e,0,0,canvasPerson.width,canvasPerson.height)};e.src=b.toDataURL()};